#!/bin/bash -e

# Se o comando é 'rails server', prepara o DB de desenvolvimento e remove o PID.
if [ "$1" == "bundle" ] && [ "$2" == "exec" ] && [ "$3" == "rails" ] && [ "$4" == "s" ]; then
    ./bin/rails db:prepare
    
    # Remove o arquivo PID que impede o servidor de iniciar se a execução anterior falhou
    if [ -f tmp/pids/server.pid ]; then
        rm tmp/pids/server.pid
    fi
fi

# Se o comando é 'rspec', prepara o DB de teste.
if [ "$1" == "bundle" ] && [ "$2" == "exec" ] && [ "$3" == "rspec" ]; then
    ./bin/rails db:prepare RAILS_ENV=test
fi

exec "$@"